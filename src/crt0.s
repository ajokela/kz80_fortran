;--------------------------------------------------------------------------
; crt0.s - Custom startup code for RetroShield Z80
;
; This provides the reset vector and initialization code needed
; before calling main().
;--------------------------------------------------------------------------

        .module crt0
        .globl  _main

        .area   _HEADER (ABS)

;--------------------------------------------------------------------------
; Reset vector at $0000
;--------------------------------------------------------------------------
        .org    0x0000

        di                      ; Disable interrupts
        jp      init            ; Jump to initialization

;--------------------------------------------------------------------------
; RST 08 - unused
;--------------------------------------------------------------------------
        .org    0x0008
        ret

;--------------------------------------------------------------------------
; RST 10 - unused
;--------------------------------------------------------------------------
        .org    0x0010
        ret

;--------------------------------------------------------------------------
; RST 18 - unused
;--------------------------------------------------------------------------
        .org    0x0018
        ret

;--------------------------------------------------------------------------
; RST 20 - unused
;--------------------------------------------------------------------------
        .org    0x0020
        ret

;--------------------------------------------------------------------------
; RST 28 - unused
;--------------------------------------------------------------------------
        .org    0x0028
        ret

;--------------------------------------------------------------------------
; RST 30 - unused
;--------------------------------------------------------------------------
        .org    0x0030
        ret

;--------------------------------------------------------------------------
; RST 38 / IM1 interrupt vector - unused
;--------------------------------------------------------------------------
        .org    0x0038
        reti

;--------------------------------------------------------------------------
; NMI vector at $0066
;--------------------------------------------------------------------------
        .org    0x0066
        retn

;--------------------------------------------------------------------------
; Initialization code (placed after vectors)
;--------------------------------------------------------------------------
        .org    0x0080

init:
        ; Set up stack at top of RAM
        ld      sp, #0x8000

        ; Call global initializers
        call    gsinit

        ; Jump to main
        jp      _main

;--------------------------------------------------------------------------
; Global initializer area (called by SDCC startup)
;--------------------------------------------------------------------------
        .area   _GSINIT
gsinit::

        .area   _GSFINAL
        ret

;--------------------------------------------------------------------------
; Memory areas
;--------------------------------------------------------------------------
        .area   _HOME
        .area   _CODE
        .area   _INITIALIZER
        .area   _DATA
        .area   _INITIALIZED
        .area   _BSEG
        .area   _BSS
        .area   _HEAP
